<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ö° VeloWatt ‚Äî Power up your cycling</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f1117; color: #e6e6e6; }
:root {
  --bg: #0f1117; --card: #1a1b26; --border: #2a2b3a; --text: #e6e6e6;
  --dim: #8b8fa3; --muted: #5a5e72; --accent: #f59e0b; --green: #16a34a;
  --red: #dc2626; --blue: #3b82f6; --purple: #a78bfa; --strava: #FC4C02;
}
input, button { font-family: inherit; }
input { width: 100%; padding: 10px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; outline: none; margin-bottom: 8px; }
input:focus { border-color: var(--accent); }
.btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
.btn:hover { opacity: 0.85; }
.btn-accent { background: var(--accent); color: var(--bg); }
.btn-strava { background: var(--strava); color: white; }
.btn-purple { background: var(--purple); color: white; }
.btn-danger { background: transparent; color: var(--red); border: 1px solid var(--red); }

/* Layout */
#app { min-height: 100vh; }
.auth-wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--bg), #151825, var(--bg)); }
.auth-box { width: 380px; padding: 40px; background: var(--card); border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
.app-layout { display: flex; min-height: 100vh; }
.sidebar { width: 76px; background: var(--card); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding-top: 20px; flex-shrink: 0; position: sticky; top: 0; height: 100vh; }
.nav-btn { width: 58px; height: 54px; background: transparent; border: 1px solid transparent; border-radius: 12px; cursor: pointer; margin-bottom: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; }
.nav-btn.active { background: rgba(245,158,11,0.08); border-color: rgba(245,158,11,0.2); }
.nav-btn span.icon { font-size: 20px; }
.nav-btn span.label { font-size: 9px; color: var(--muted); margin-top: 3px; }
.nav-btn.active span.label { color: var(--accent); font-weight: 700; }
.content { flex: 1; padding: 28px; overflow-y: auto; max-height: 100vh; }

/* Cards */
.metric-card { padding: 14px 18px; background: var(--card); border-radius: 12px; border: 1px solid var(--border); min-width: 110px; flex: 1; transition: border-color 0.2s; }
.metric-card:hover { border-color: var(--accent); }
.metric-label { font-size: 11px; color: var(--dim); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
.metric-value { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
.metric-unit { font-size: 13px; color: var(--dim); font-weight: 500; margin-left: 4px; }
.card { padding: 18px; background: var(--card); border-radius: 14px; border: 1px solid var(--border); margin-bottom: 16px; }

/* Rides */
.ride-row { display: flex; align-items: center; padding: 12px 16px; background: var(--card); border-radius: 10px; border: 1px solid var(--border); margin-bottom: 6px; gap: 14px; transition: border-color 0.2s; }
.ride-row:hover { border-color: rgba(245,158,11,0.25); }

/* Chat */
.chat-wrap { display: flex; flex-direction: column; height: calc(100vh - 100px); }
.chat-messages { flex: 1; overflow-y: auto; padding: 10px 0; }
.chat-bubble { max-width: 75%; padding: 12px 16px; font-size: 13px; line-height: 1.7; white-space: pre-wrap; }
.chat-user { background: linear-gradient(135deg, var(--accent), #d97706); color: var(--bg); border-radius: 16px 16px 4px 16px; }
.chat-bot { background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 16px 16px 16px 4px; }
.chat-input { display: flex; gap: 8px; padding: 12px 0; border-top: 1px solid var(--border); }

.flex { display: flex; } .flex-wrap { flex-wrap: wrap; } .gap-10 { gap: 10px; } .gap-8 { gap: 8px; } .gap-12 { gap: 12px; }
.mb-20 { margin-bottom: 20px; } .mb-12 { margin-bottom: 12px; } .mt-8 { margin-top: 8px; }
.text-center { text-align: center; }
.hidden { display: none; }

@media (max-width: 700px) {
  .sidebar { width: 56px; } .content { padding: 16px; }
  .metric-card { min-width: 90px; } .metric-value { font-size: 22px; }
  .auth-box { width: 95%; padding: 24px; }
}
</style>
</head>
<body>
<div id="app"></div>
<script>
const API = window.location.origin;
let authToken = localStorage.getItem("vw_token") || "";
let currentUser = null;
let currentView = "dashboard";

// ‚îÄ‚îÄ API ‚îÄ‚îÄ
async function apiFetch(path, opts = {}) {
  const headers = { "Content-Type": "application/json", ...(opts.headers || {}) };
  if (authToken) headers["Authorization"] = "Bearer " + authToken;
  const res = await fetch(API + path, { ...opts, headers });
  if (res.status === 401) { logout(); return null; }
  return res.json();
}
const apiGet = (p) => apiFetch(p);
const apiPost = (p, b) => apiFetch(p, { method: "POST", body: JSON.stringify(b) });
const apiPut = (p, b) => apiFetch(p, { method: "PUT", body: JSON.stringify(b) });
const apiDel = (p) => apiFetch(p, { method: "DELETE" });

function setToken(t) { authToken = t; localStorage.setItem("vw_token", t); }
function logout() { authToken = ""; localStorage.removeItem("vw_token"); currentUser = null; render(); }

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function formatDuration(s) {
  if (!s) return "‚Äî";
  const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60);
  return h > 0 ? h + "h " + String(m).padStart(2,"0") + "m" : m + "m";
}
function intensityLabel(v) {
  if (!v) return "‚Äî";
  if (v < 0.55) return "Recovery"; if (v < 0.75) return "Endurance"; if (v < 0.90) return "Tempo";
  if (v < 1.05) return "Threshold"; if (v < 1.20) return "VO2max"; return "Anaerobic";
}
function intensityColor(v) {
  if (!v) return "var(--dim)";
  if (v < 0.55) return "#6b7280"; if (v < 0.75) return "var(--green)"; if (v < 0.90) return "var(--accent)";
  if (v < 1.05) return "#f97316"; if (v < 1.20) return "var(--red)"; return "#dc2626";
}

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
function renderAuth() {
  let mode = "login";
  const app = document.getElementById("app");
  function draw() {
    app.innerHTML = `
    <div class="auth-wrap">
      <div class="auth-box">
        <div class="text-center" style="margin-bottom:32px">
          <div style="font-size:44px;margin-bottom:8px;filter:drop-shadow(0 0 12px rgba(245,158,11,0.4))">‚ö°</div>
          <h1 style="color:var(--accent);font-size:32px;font-weight:800">VeloWatt</h1>
          <p style="color:var(--dim);font-size:13px;margin-top:6px">Power up your cycling</p>
        </div>
        <form id="authForm">
          ${mode === "register" ? '<input id="aName" placeholder="Name" />' : ""}
          <input id="aEmail" type="email" placeholder="Email" required />
          <input id="aPass" type="password" placeholder="Password" required minlength="6" />
          <p id="authErr" style="color:var(--red);font-size:13px;margin:8px 0;display:none"></p>
          <button type="submit" class="btn btn-accent" style="width:100%;margin-top:8px;padding:12px;font-size:15px">${mode === "login" ? "Log In" : "Create Account"}</button>
        </form>
        <p id="toggleAuth" style="color:var(--dim);font-size:13px;text-align:center;margin-top:16px;cursor:pointer">
          ${mode === "login" ? "Don't have an account? Sign up" : "Already have an account? Log in"}
        </p>
        <div style="position:relative;text-align:center;margin:20px 0 16px"><div style="position:absolute;top:50%;left:0;right:0;height:1px;background:var(--border)"></div><span style="position:relative;background:var(--card);padding:0 12px;color:var(--muted);font-size:12px">or</span></div>
        <button class="btn" style="width:100%;padding:12px;background:#FC4C02;color:white;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px" onclick="stravaLogin()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/></svg>
          Continue with Strava
        </button>
      </div>
    </div>`;
    document.getElementById("toggleAuth").onclick = () => { mode = mode === "login" ? "register" : "login"; draw(); };
    document.getElementById("authForm").onsubmit = async (e) => {
      e.preventDefault();
      const email = document.getElementById("aEmail").value;
      const password = document.getElementById("aPass").value;
      const name = document.getElementById("aName")?.value || "Cyclist";
      const errEl = document.getElementById("authErr");
      errEl.style.display = "none";
      try {
        const endpoint = mode === "login" ? "/auth/login" : "/auth/register";
        const body = mode === "login" ? { email, password } : { email, password, name };
        const res = await apiPost(endpoint, body);
        if (res && res.token) { setToken(res.token); currentUser = res.user; render(); }
        else { errEl.textContent = res?.detail || "Failed"; errEl.style.display = "block"; }
      } catch(e) { errEl.textContent = "Connection error"; errEl.style.display = "block"; }
    };
  }
  draw();
}

async function stravaLogin() {
  try {
    const res = await fetch(API + "/api/strava/login-url").then(r => r.json());
    if (res?.url) window.location.href = res.url;
  } catch(e) { alert("Error connecting to Strava"); }
}

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ
async function renderDashboard() {
  const el = document.getElementById("viewContent");
  el.innerHTML = '<div style="color:var(--dim);padding:40px;text-align:center">Loading dashboard...</div>';

  const [fitness, rides, settings, ftpEst, analysis] = await Promise.all([
    apiGet("/api/fitness").catch(() => null),
    apiGet("/api/rides?limit=10").catch(() => []),
    apiGet("/api/settings").catch(() => ({})),
    apiGet("/api/ftp-estimate").catch(() => null),
    apiPost("/api/rides/analyze-latest", {}).catch(() => null),
  ]);

  const ftp = settings?.ftp || 200;
  let html = '<h2 style="font-size:24px;font-weight:800;margin-bottom:20px">Dashboard</h2>';

  // Metrics
  if (fitness) {
    html += '<div class="flex flex-wrap gap-10 mb-20">';
    html += metricCard("CTL (Fitness)", fitness.current_ctl, "", "var(--green)");
    html += metricCard("ATL (Fatigue)", fitness.current_atl, "", "var(--red)");
    html += metricCard("TSB (Form)", fitness.current_tsb, "", "var(--blue)");
    html += metricCard("Peak CTL", fitness.peak_ctl, "", "var(--green)");
    html += metricCard("FTP", Math.round(ftp), "W", "var(--accent)");
    if (ftpEst?.estimated_ftp) html += metricCard("Est. FTP", Math.round(ftpEst.estimated_ftp), "W", "var(--blue)");
    const totalRides = await apiGet("/api/rides?limit=9999").catch(() => []);
    const rideCount = Array.isArray(totalRides) ? totalRides.length : 0;
    html += metricCard("Total Rides", rideCount, "", "var(--dim)");
    html += '</div>';
  }

  // AI Analysis
  if (analysis?.analysis) {
    html += `<div class="card" style="border-color:var(--purple);position:relative;overflow:hidden">
      <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--purple),transparent)"></div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <span style="font-size:18px">‚ú®</span>
        <span style="color:var(--purple);font-size:14px;font-weight:700">AI Analysis</span>
        <span style="color:var(--dim);font-size:12px">‚Äî ${analysis.title || ""}</span>
      </div>
      <p style="font-size:13px;line-height:1.7">${analysis.analysis}</p>
    </div>`;
  }

  // PMC Chart
  if (fitness?.history?.length > 2) {
    html += renderPMC(fitness);
  }

  // Rides
  if (rides && rides.length > 0) {
    html += '<h3 style="font-size:16px;font-weight:700;margin:20px 0 12px">Recent Rides</h3>';
    for (const r of rides) {
      html += `<div class="ride-row">
        <div style="flex:1"><div style="font-weight:600;font-size:14px">${r.title}</div><div style="color:var(--muted);font-size:11px;margin-top:2px">${r.ride_date}</div></div>
        <span style="color:var(--dim);font-size:12px;min-width:55px;text-align:right">${formatDuration(r.duration_seconds)}</span>
        <span style="color:var(--blue);font-size:12px;font-weight:600;min-width:50px;text-align:right">${r.avg_power}W</span>
        <span style="color:var(--accent);font-size:13px;font-weight:700;min-width:45px;text-align:right">${r.tss}</span>
        <span style="color:${intensityColor(r.intensity_factor)};font-size:11px;font-weight:700;min-width:75px;text-align:right">${intensityLabel(r.intensity_factor)}</span>
      </div>`;
    }
  } else {
    html += `<div class="text-center" style="padding:40px;color:var(--dim)">
      <div style="font-size:40px;margin-bottom:12px">üö¥</div>
      <p style="font-size:16px;font-weight:600">No rides yet!</p>
      <p style="font-size:13px;margin-top:8px">Add a ride manually or sync from Strava.</p>
    </div>`;
  }

  el.innerHTML = html;
}

function metricCard(label, value, unit, color) {
  return `<div class="metric-card"><div class="metric-label">${label}</div>
    <span class="metric-value" style="color:${color}">${value ?? "‚Äî"}</span>${unit ? `<span class="metric-unit">${unit}</span>` : ""}
  </div>`;
}

function renderPMC(fitness) {
  // Limit to last 120 days of history + forecast
  const historyDays = 120;
  const trimmedHistory = fitness.history.length > historyDays ? fitness.history.slice(-historyDays) : fitness.history;
  const all = [...trimmedHistory, ...(fitness.forecast || [])];
  const hLen = trimmedHistory.length;
  const W = 700, H = 220, P = {t:15,r:15,b:30,l:42};
  const cW = W-P.l-P.r, cH = H-P.t-P.b;
  const vals = all.flatMap(d => [d.ctl, d.atl, d.tsb]);
  const mn = Math.min(...vals, -10), mx = Math.max(...vals, 10), rng = mx - mn || 1;
  const x = i => P.l + (i / Math.max(all.length-1,1)) * cW;
  const y = v => P.t + cH - ((v - mn) / rng) * cH;
  const line = (data, key, si=0) => data.map((d,i) => `${i===0?"M":"L"}${x(si+i)} ${y(d[key])}`).join(" ");
  const hd = all.slice(0, hLen), fd = all.slice(hLen-1);
  let grid = "";
  for (let i = 0; i < 5; i++) { const v = mn + (rng/4)*i; grid += `<line x1="${P.l}" y1="${y(v)}" x2="${W-P.r}" y2="${y(v)}" stroke="var(--border)" stroke-width="0.3"/><text x="${P.l-4}" y="${y(v)+3}" fill="var(--muted)" font-size="9" text-anchor="end">${Math.round(v)}</text>`; }
  const step = Math.max(1, Math.floor(all.length / 7));
  let labels = "";
  for (let i = 0; i < all.length; i += step) labels += `<text x="${x(i)}" y="${H-4}" fill="var(--muted)" font-size="9" text-anchor="middle">${all[i].date.slice(5)}</text>`;
  let forecast = "";
  if (fd.length > 1) forecast = `<path d="${line(fd,"ctl",hLen-1)}" fill="none" stroke="var(--green)" stroke-width="1.2" stroke-dasharray="5 3" opacity="0.5"/>
    <path d="${line(fd,"atl",hLen-1)}" fill="none" stroke="var(--red)" stroke-width="1.2" stroke-dasharray="5 3" opacity="0.5"/>
    <path d="${line(fd,"tsb",hLen-1)}" fill="none" stroke="var(--blue)" stroke-width="1.2" stroke-dasharray="5 3" opacity="0.5"/>`;

  return `<div class="card mb-20"><h3 style="font-size:15px;font-weight:700;margin-bottom:12px">Performance Management Chart</h3>
    <svg viewBox="0 0 ${W} ${H}" style="width:100%;height:auto">
      <line x1="${P.l}" y1="${y(0)}" x2="${W-P.r}" y2="${y(0)}" stroke="var(--border)" stroke-width="0.5"/>${grid}
      <path d="${line(hd,"ctl")}" fill="none" stroke="var(--green)" stroke-width="2"/>
      <path d="${line(hd,"atl")}" fill="none" stroke="var(--red)" stroke-width="2"/>
      <path d="${line(hd,"tsb")}" fill="none" stroke="var(--blue)" stroke-width="2"/>${forecast}${labels}
    </svg>
    <div style="display:flex;gap:20px;justify-content:center;margin-top:10px">
      <span style="font-size:11px;color:var(--green)">‚óè CTL</span>
      <span style="font-size:11px;color:var(--red)">‚óè ATL</span>
      <span style="font-size:11px;color:var(--blue)">‚óè TSB</span>
      <span style="font-size:11px;color:var(--muted)">‚îà Forecast</span>
    </div></div>`;
}

// ‚îÄ‚îÄ Add Ride ‚îÄ‚îÄ
function renderAddRide() {
  const el = document.getElementById("viewContent");
  el.innerHTML = `<h2 style="font-size:24px;font-weight:800;margin-bottom:16px">Add Ride</h2>
    
    <div class="card" style="max-width:500px;margin-bottom:16px">
      <h3 style="font-size:16px;font-weight:700;margin-bottom:12px">üìÅ Import .FIT File</h3>
      <p style="color:var(--dim);font-size:12px;margin-bottom:12px">Upload a .FIT file from Garmin, Wahoo, or Hammerhead</p>
      <input type="file" id="fitFile" accept=".fit" style="padding:8px;margin-bottom:8px" />
      <button class="btn btn-accent" style="width:100%" onclick="uploadFit()">Upload & Import</button>
      <div id="fitResult"></div>
    </div>

    <div class="card" style="max-width:500px">
      <h3 style="font-size:16px;font-weight:700;margin-bottom:12px">‚úèÔ∏è Manual Entry</h3>
      <input id="rTitle" placeholder="Ride Title" value="Ride" />
      <input id="rDate" type="date" value="${new Date().toISOString().split("T")[0]}" />
      <div class="flex gap-8"><input id="rH" placeholder="Hours" value="1" type="number" style="flex:1"/><input id="rM" placeholder="Minutes" value="30" type="number" style="flex:1"/></div>
      <input id="rPow" placeholder="Avg Power (W) *" type="number" />
      <input id="rNP" placeholder="NP (optional)" type="number" />
      <input id="rHR" placeholder="Avg HR (optional)" type="number" />
      <input id="rDist" placeholder="Distance km (optional)" type="number" step="0.1" />
      <input id="rElev" placeholder="Elevation gain m (optional)" type="number" />
      <p id="rErr" style="color:var(--red);font-size:13px;display:none"></p>
      <button class="btn btn-accent" style="width:100%;margin-top:4px" onclick="submitRide()">Save Ride</button>
      <div id="rResult"></div>
    </div>`;
}
async function uploadFit() {
  const fileInput = document.getElementById("fitFile");
  const resultEl = document.getElementById("fitResult");
  if (!fileInput.files.length) { resultEl.innerHTML = '<p style="color:var(--red);font-size:13px;margin-top:8px">Select a .FIT file first</p>'; return; }
  resultEl.innerHTML = '<p style="color:var(--dim);font-size:13px;margin-top:8px">‚è≥ Uploading and parsing...</p>';
  const formData = new FormData();
  formData.append("file", fileInput.files[0]);
  try {
    const res = await fetch(API + "/api/import/fit", { method: "POST", headers: { "Authorization": "Bearer " + authToken }, body: formData });
    const data = await res.json();
    if (data?.id) {
      let html = '<div style="margin-top:12px;padding:14px;background:var(--bg);border-radius:10px;font-size:13px;border:1px solid rgba(22,163,106,0.25)">';
      html += '‚úÖ <strong>' + data.title + '</strong> imported!<br>';
      html += 'TSS: ' + data.tss + ' | IF: ' + data.intensity_factor + ' | NP: ' + (data.normalized_power || 'N/A') + 'W<br>';
      html += 'Duration: ' + formatDuration(data.duration_seconds) + ' | Avg: ' + data.avg_power + 'W';
      if (data.ai_summary) html += '<div style="margin-top:10px;padding:10px;border-radius:8px;border:1px solid var(--purple)"><span style="color:var(--purple);font-size:11px;font-weight:700">‚ú® AI Analysis</span><p style="font-size:12px;margin-top:4px;line-height:1.5">' + data.ai_summary + '</p></div>';
      html += '</div>';
      resultEl.innerHTML = html;
    } else {
      resultEl.innerHTML = '<p style="color:var(--red);font-size:13px;margin-top:8px">Error: ' + (data.detail || 'Import failed') + '</p>';
    }
  } catch(e) { resultEl.innerHTML = '<p style="color:var(--red);font-size:13px;margin-top:8px">Upload error: ' + e.message + '</p>'; }
}
async function submitRide() {
  const pow = document.getElementById("rPow").value;
  if (!pow) { document.getElementById("rErr").textContent = "Avg Power required"; document.getElementById("rErr").style.display = "block"; return; }
  const dur = (parseInt(document.getElementById("rH").value||0)*3600) + (parseInt(document.getElementById("rM").value||0)*60);
  const body = { title: document.getElementById("rTitle").value, ride_date: document.getElementById("rDate").value, duration_seconds: dur, avg_power: parseFloat(pow) };
  const np = document.getElementById("rNP").value; if (np) body.normalized_power = parseFloat(np);
  const hr = document.getElementById("rHR").value; if (hr) body.avg_heart_rate = parseFloat(hr);
  const dist = document.getElementById("rDist").value; if (dist) body.distance_km = parseFloat(dist);
  const elev = document.getElementById("rElev").value; if (elev) body.elevation_gain_m = parseFloat(elev);
  const res = await apiPost("/api/rides", body);
  if (res?.id) {
    document.getElementById("rResult").innerHTML = `<div style="margin-top:14px;padding:14px;background:var(--bg);border-radius:10px;font-size:13px;border:1px solid rgba(22,163,106,0.25)">‚úÖ Ride saved! TSS: ${res.tss} | IF: ${res.intensity_factor} | NP: ${res.normalized_power}W</div>`;
  }
}

// ‚îÄ‚îÄ History ‚îÄ‚îÄ
let historyPage = 0;
async function renderHistory() {
  const el = document.getElementById("viewContent");
  el.innerHTML = '<div style="color:var(--dim);padding:40px;text-align:center">Loading ride history...</div>';
  historyPage = 0;
  await loadHistoryPage(el);
}
async function loadHistoryPage(el) {
  const limit = 50;
  const rides = await apiGet("/api/rides?limit=" + limit + "&offset=" + (historyPage * limit)).catch(() => []);
  const total = await apiGet("/api/rides?limit=9999").catch(() => []);
  const totalCount = Array.isArray(total) ? total.length : 0;

  let html = '<h2 style="font-size:24px;font-weight:800;margin-bottom:16px">Ride History</h2>';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="color:var(--dim);font-size:13px">' + totalCount + ' rides total</span></div>';

  // Table header
  html += '<div style="display:flex;padding:8px 16px;gap:14px;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">';
  html += '<div style="flex:1">Ride</div><div style="min-width:55px;text-align:right">Duration</div><div style="min-width:50px;text-align:right">Power</div><div style="min-width:50px;text-align:right">NP</div><div style="min-width:45px;text-align:right">TSS</div><div style="min-width:40px;text-align:right">IF</div><div style="min-width:75px;text-align:right">Zone</div><div style="min-width:55px;text-align:right">Dist</div><div style="min-width:30px"></div>';
  html += '</div>';

  if (rides && rides.length) {
    for (const r of rides) {
      html += `<div class="ride-row">
        <div style="flex:1"><div style="font-weight:600;font-size:14px">${r.title}</div><div style="color:var(--muted);font-size:11px;margin-top:2px">${r.ride_date}</div></div>
        <span style="color:var(--dim);font-size:12px;min-width:55px;text-align:right">${formatDuration(r.duration_seconds)}</span>
        <span style="color:var(--blue);font-size:12px;font-weight:600;min-width:50px;text-align:right">${r.avg_power}W</span>
        <span style="color:var(--blue);font-size:12px;min-width:50px;text-align:right">${r.normalized_power ? Math.round(r.normalized_power) + 'W' : '‚Äî'}</span>
        <span style="color:var(--accent);font-size:13px;font-weight:700;min-width:45px;text-align:right">${r.tss}</span>
        <span style="color:var(--dim);font-size:12px;min-width:40px;text-align:right">${r.intensity_factor || '‚Äî'}</span>
        <span style="color:${intensityColor(r.intensity_factor)};font-size:11px;font-weight:700;min-width:75px;text-align:right">${intensityLabel(r.intensity_factor)}</span>
        <span style="color:var(--dim);font-size:12px;min-width:55px;text-align:right">${r.distance_km ? r.distance_km + 'km' : '‚Äî'}</span>
        <span style="color:var(--muted);cursor:pointer;font-size:13px;min-width:30px;text-align:right" onclick="deleteRide(${r.id})">üóë</span>
      </div>`;
    }
  } else {
    html += '<div class="text-center" style="padding:40px;color:var(--dim)"><p>No rides yet</p></div>';
  }

  // Pagination
  if (rides && rides.length >= limit) {
    html += '<div style="text-align:center;margin-top:16px"><button class="btn btn-accent" onclick="nextHistoryPage()">Load More</button></div>';
  }

  el.innerHTML = html;
}
async function nextHistoryPage() {
  historyPage++;
  const el = document.getElementById("viewContent");
  await loadHistoryPage(el);
}
async function deleteRide(id) {
  if (!confirm("Delete this ride?")) return;
  await apiDel("/api/rides/" + id);
  renderHistory();
}

// ‚îÄ‚îÄ Zones ‚îÄ‚îÄ
async function renderZones() {
  const el = document.getElementById("viewContent");
  el.innerHTML = '<div style="color:var(--dim);padding:40px;text-align:center">Loading zones...</div>';
  const data = await apiGet("/api/zones").catch(() => null);
  if (!data) { el.innerHTML = '<p style="color:var(--red)">Failed to load zones</p>'; return; }
  const ftp = data.ftp;
  const zones = [
    { name: "Z1 Recovery", min: 0, max: Math.round(ftp * 0.55), color: "#6b7280" },
    { name: "Z2 Endurance", min: Math.round(ftp * 0.55), max: Math.round(ftp * 0.75), color: "#3b82f6" },
    { name: "Z3 Tempo", min: Math.round(ftp * 0.75), max: Math.round(ftp * 0.90), color: "#16a34a" },
    { name: "Z4 Threshold", min: Math.round(ftp * 0.90), max: Math.round(ftp * 1.05), color: "#f59e0b" },
    { name: "Z5 VO2max", min: Math.round(ftp * 1.05), max: Math.round(ftp * 1.20), color: "#f97316" },
    { name: "Z6 Anaerobic", min: Math.round(ftp * 1.20), max: Math.round(ftp * 1.50), color: "#dc2626" },
    { name: "Z7 Neuromuscular", min: Math.round(ftp * 1.50), max: 9999, color: "#7c3aed" },
  ];
  let html = '<h2 style="font-size:24px;font-weight:800;margin-bottom:16px">Power Zones</h2>';
  html += '<div class="card" style="max-width:500px"><p style="color:var(--dim);font-size:13px;margin-bottom:16px">Based on FTP: <strong style="color:var(--accent)">' + ftp + 'W</strong></p>';
  for (const z of zones) {
    const pct = Math.min(100, (z.max / (ftp * 1.5)) * 100);
    html += `<div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:13px;font-weight:600;color:${z.color}">${z.name}</span><span style="font-size:12px;color:var(--dim)">${z.min} - ${z.max > 9000 ? '‚àû' : z.max}W</span></div>
      <div style="height:8px;background:var(--bg);border-radius:4px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${z.color};border-radius:4px"></div></div>
    </div>`;
  }
  html += '</div>';
  el.innerHTML = html;
}

// ‚îÄ‚îÄ Strava ‚îÄ‚îÄ
async function renderStrava() {
  const el = document.getElementById("viewContent");
  el.innerHTML = '<div style="color:var(--dim);padding:40px;text-align:center">Loading Strava status...</div>';
  const status = await apiGet("/api/strava/status").catch(() => null);
  el.innerHTML = `<h2 style="font-size:24px;font-weight:800;margin-bottom:16px">Strava Sync</h2>
    <div class="card">
      ${status ? `<p style="color:${status.connected ? "var(--green)" : "var(--accent)"};font-size:14px;margin-bottom:16px;font-weight:500">${status.connected ? "‚úÖ" : "‚ö†Ô∏è"} ${status.message}</p>` : ""}
      <div class="flex gap-12 flex-wrap">
        <button class="btn btn-strava" onclick="connectStrava()">Connect Strava</button>
        <button class="btn btn-accent" id="syncBtn" onclick="syncStrava()">Sync Rides</button>
      </div>
      <p style="color:var(--muted);font-size:11px;margin-top:12px">OAuth2 ‚Äî your Strava password is never shared with VeloWatt</p>
    </div>
    <div id="syncResults"></div>`;
}
async function connectStrava() {
  const res = await apiGet("/api/strava/auth-url");
  if (res?.url) window.open(res.url, "_blank");
}
async function syncStrava() {
  document.getElementById("syncBtn").textContent = "Syncing...";
  document.getElementById("syncBtn").disabled = true;
  const res = await apiPost("/api/strava/sync", {}).catch(() => null);
  document.getElementById("syncBtn").textContent = "Sync Rides";
  document.getElementById("syncBtn").disabled = false;
  if (!res) return;
  let html = `<div class="card" style="margin-top:16px"><p style="color:var(--green);font-weight:700;margin-bottom:12px;font-size:14px">‚úÖ Imported: ${res.imported} | Skipped: ${res.skipped} | Errors: ${res.errors}</p>`;
  if (res.ai_analysis?.analysis) {
    html += `<div style="padding:14px;border-radius:10px;border:1px solid var(--purple);margin-bottom:12px"><span style="color:var(--purple);font-size:12px;font-weight:700">‚ú® AI Analysis ‚Äî ${res.ai_analysis.ride}</span><p style="font-size:12px;margin-top:6px;line-height:1.6">${res.ai_analysis.analysis}</p></div>`;
  }
  if (res.imported_rides) for (const r of res.imported_rides) {
    html += `<div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:12px"><span style="flex:1;font-size:13px">‚úÖ ${r.name}</span><span style="color:var(--dim);font-size:12px">${r.date}</span><span style="color:var(--accent);font-size:12px;font-weight:600">TSS ${r.tss}</span></div>`;
  }
  html += '</div>';
  document.getElementById("syncResults").innerHTML = html;
}

// ‚îÄ‚îÄ AI Coach ‚îÄ‚îÄ
let chatHistory = [];
let coachStatus = null;
async function renderCoach() {
  const el = document.getElementById("viewContent");
  coachStatus = await apiGet("/api/coach/status").catch(() => null);
  const limitInfo = coachStatus && !coachStatus.is_pro ? `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--bg);border-radius:8px;margin-bottom:12px;border:1px solid var(--border)"><span style="color:var(--dim);font-size:12px">${coachStatus.message}</span>${coachStatus.messages_remaining <= 0 ? '<span style="color:var(--accent);font-size:12px;font-weight:600">‚ö° Upgrade to Pro</span>' : ''}</div>` : (coachStatus?.is_pro ? '<div style="padding:8px 14px;background:var(--bg);border-radius:8px;margin-bottom:12px;border:1px solid var(--accent)"><span style="color:var(--accent);font-size:12px;font-weight:600">‚ö° Pro ‚Äî Unlimited AI Coach</span></div>' : '');
  el.innerHTML = `<div class="chat-wrap">
    <h2 style="font-size:24px;font-weight:800;margin-bottom:12px">AI Coach</h2>
    ${limitInfo}
    <div class="chat-messages" id="chatMsgs">
      ${chatHistory.length === 0 ? `<div class="text-center" style="padding:60px 20px">
        <div style="font-size:48px;margin-bottom:16px">üö¥‚Äç‚ôÇÔ∏è</div>
        <p style="font-size:16px;font-weight:600;margin-bottom:8px">Your AI Cycling Coach</p>
        <p style="color:var(--dim);font-size:14px;margin-bottom:24px">Ask about training, gym workouts, race prep, or recovery</p>
        <div class="flex gap-8 flex-wrap" style="justify-content:center">
          <button class="btn" style="background:var(--card);color:var(--text);border:1px solid var(--border);font-size:12px;padding:8px 16px;border-radius:20px" onclick="setChat('What should I do today?')">What should I do today?</button>
          <button class="btn" style="background:var(--card);color:var(--text);border:1px solid var(--border);font-size:12px;padding:8px 16px;border-radius:20px" onclick="setChat('Create a gym workout for cycling')">Gym workout for cycling</button>
          <button class="btn" style="background:var(--card);color:var(--text);border:1px solid var(--border);font-size:12px;padding:8px 16px;border-radius:20px" onclick="setChat('Analyze my training load')">Analyze my training load</button>
          <button class="btn" style="background:var(--card);color:var(--text);border:1px solid var(--border);font-size:12px;padding:8px 16px;border-radius:20px" onclick="setChat('Help me peak for a race')">Help me peak for a race</button>
        </div>
      </div>` : chatHistory.map(m => `<div style="display:flex;justify-content:${m.role==="user"?"flex-end":"flex-start"};margin-bottom:10px"><div class="chat-bubble ${m.role==="user"?"chat-user":"chat-bot"}">${m.content}</div></div>`).join("")}
    </div>
    <div class="chat-input">
      <input id="chatInput" placeholder="Ask your coach..." style="flex:1;margin:0;border-radius:20px;padding:12px 18px" onkeydown="if(event.key==='Enter')sendChat()" />
      <button class="btn btn-accent" style="border-radius:20px;padding:10px 24px" onclick="sendChat()">Send</button>
    </div>
  </div>`;
  const msgs = document.getElementById("chatMsgs");
  if (msgs) msgs.scrollTop = msgs.scrollHeight;
}
function setChat(t) { document.getElementById("chatInput").value = t; }
async function sendChat() {
  const input = document.getElementById("chatInput");
  const msg = input.value.trim(); if (!msg) return;
  input.value = "";
  chatHistory.push({ role: "user", content: msg });
  renderCoach();
  // Show thinking
  const msgs = document.getElementById("chatMsgs");
  msgs.innerHTML += '<div style="display:flex;justify-content:flex-start;margin-bottom:10px"><div class="chat-bubble chat-bot" style="color:var(--dim)">Thinking...</div></div>';
  msgs.scrollTop = msgs.scrollHeight;
  const history = chatHistory.slice(0, -1).map(m => ({role: m.role, content: m.content}));
  const res = await apiPost("/api/coach/chat", { message: msg, history }).catch(() => ({response: "Error connecting to AI Coach."}));
  chatHistory.push({ role: "assistant", content: res.response });
  renderCoach();
}

// ‚îÄ‚îÄ Admin: Set user as Pro (via /docs for now) ‚îÄ‚îÄ

// ‚îÄ‚îÄ Settings ‚îÄ‚îÄ
async function renderSettings() {
  const el = document.getElementById("viewContent");
  el.innerHTML = '<div style="color:var(--dim);padding:40px;text-align:center">Loading settings...</div>';
  const s = await apiGet("/api/settings").catch(() => ({}));
  el.innerHTML = `<h2 style="font-size:24px;font-weight:800;margin-bottom:16px">Settings</h2>
    <div class="card" style="max-width:420px">
      <input id="sName" placeholder="Name" value="${s.name || ""}" />
      <input id="sFtp" placeholder="FTP (watts)" value="${s.ftp || 200}" type="number" />
      <input id="sWeight" placeholder="Weight (kg)" value="${s.weight_kg || 75}" type="number" />
      <div class="flex gap-10" style="margin-top:4px">
        <button class="btn btn-accent" onclick="saveSettings()">Save Settings</button>
        <button class="btn btn-purple" onclick="recalcRides()">Recalculate All Rides</button>
      </div>
      <p id="sMsg" style="color:var(--green);font-size:13px;margin-top:10px;display:none"></p>
      <p style="color:var(--dim);font-size:11px;margin-top:14px">After changing FTP, click "Recalculate" to update TSS/IF for all rides.</p>
    </div>
    <button class="btn btn-danger" style="margin-top:24px" onclick="logout()">Log Out</button>`;
}
async function saveSettings() {
  await apiPut("/api/settings", { ftp: parseFloat(document.getElementById("sFtp").value), name: document.getElementById("sName").value, weight_kg: parseFloat(document.getElementById("sWeight").value) });
  const m = document.getElementById("sMsg"); m.textContent = "‚úÖ Settings saved!"; m.style.display = "block";
}
async function recalcRides() {
  const m = document.getElementById("sMsg"); m.textContent = "‚è≥ Recalculating..."; m.style.display = "block";
  const res = await apiPost("/api/recalculate", {});
  m.textContent = "‚úÖ " + (res?.rides_updated || 0) + " rides recalculated with FTP=" + (res?.ftp_used || "?") + "W";
}

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
function navigate(view) {
  currentView = view;
  document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
  document.getElementById("nav-" + view)?.classList.add("active");
  if (view === "dashboard") renderDashboard();
  else if (view === "add") renderAddRide();
  else if (view === "history") renderHistory();
  else if (view === "strava") renderStrava();
  else if (view === "coach") renderCoach();
  else if (view === "zones") renderZones();
  else if (view === "settings") renderSettings();
}

// ‚îÄ‚îÄ Main Render ‚îÄ‚îÄ
function renderApp() {
  const initial = (currentUser?.name || "U")[0].toUpperCase();
  document.getElementById("app").innerHTML = `<div class="app-layout">
    <div class="sidebar">
      <div style="margin-bottom:28px;text-align:center">
        <div style="font-size:26px;filter:drop-shadow(0 0 8px rgba(245,158,11,0.3))">‚ö°</div>
        <div style="color:var(--accent);font-size:10px;font-weight:800;letter-spacing:0.5px;margin-top:2px">VELOWATT</div>
      </div>
      <button class="nav-btn active" id="nav-dashboard" onclick="navigate('dashboard')"><span class="icon">üìä</span><span class="label">Dashboard</span></button>
      <button class="nav-btn" id="nav-add" onclick="navigate('add')"><span class="icon">‚ûï</span><span class="label">Add Ride</span></button>
      <button class="nav-btn" id="nav-history" onclick="navigate('history')"><span class="icon">üìã</span><span class="label">History</span></button>
      <button class="nav-btn" id="nav-strava" onclick="navigate('strava')"><span class="icon">üö¥</span><span class="label">Strava</span></button>
      <button class="nav-btn" id="nav-coach" onclick="navigate('coach')"><span class="icon">ü§ñ</span><span class="label">AI Coach</span></button>
      <button class="nav-btn" id="nav-zones" onclick="navigate('zones')"><span class="icon">‚ö°</span><span class="label">Zones</span></button>
      <button class="nav-btn" id="nav-settings" onclick="navigate('settings')"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></button>
      <div style="flex:1"></div>
      <div style="margin-bottom:16px;text-align:center">
        <div style="width:32px;height:32px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;color:var(--bg);font-weight:700;font-size:14px">${initial}</div>
      </div>
    </div>
    <div class="content" id="viewContent"></div>
  </div>`;
  renderDashboard();
}

async function render() {
  if (!authToken) { renderAuth(); return; }
  try {
    const me = await apiGet("/auth/me");
    if (me && me.id) { currentUser = me; renderApp(); }
    else { logout(); }
  } catch(e) { logout(); }
}

// Boot
render();
</script>
</body>
</html>
